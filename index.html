<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 强制禁用缓存 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>玫瑰-品类 报告分享中心</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #fdf2f8 0%, #f8f4ff 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #374151;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(90deg, #f472b6 0%, #c084fc 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .admin-entrance {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 500;
        }

        .admin-entrance:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .admin-entrance.admin-mode {
            background: #ef4444;
            border-color: #dc2626;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #6b7280;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.loading {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .debug-info {
            background: #e0f2fe;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0369a1;
            font-size: 0.9em;
        }

        .filters-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .filters-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 120px;
        }

        .filter-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9em;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
            transition: border-color 0.2s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #f472b6;
            box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.2);
        }

        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .view-modes {
            display: flex;
            gap: 10px;
        }

        .view-mode-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-weight: 500;
        }

        .view-mode-btn:hover {
            border-color: #f472b6;
            background: #fdf2f8;
        }

        .view-mode-btn.active {
            border-color: #f472b6;
            background: #f472b6;
            color: white;
        }

        .results-info {
            color: #6b7280;
            font-size: 0.9em;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .report-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #f472b6;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .report-header {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .report-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .report-meta {
            color: #6b7280;
            font-size: 0.9em;
        }

        .report-content {
            padding: 20px;
        }

        .report-preview {
            width: 100%;
            height: 200px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 0.9em;
        }

        .report-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #f472b6, #c084fc);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 114, 182, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .admin-entrance {
                position: static;
                margin-top: 15px;
            }

            .reports-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .filters-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                min-width: auto;
            }

            .status-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="admin-entrance" id="adminBtn" onclick="toggleAdminMode()">
            🔧 管理员入口
        </button>
        <h1>📊 玫瑰-品类 报告分享中心</h1>
        <p id="headerDesc">市场报告 · 在线查看 · by月更新</p>
    </div>

    <div class="container">
        <!-- 调试信息 -->
        <div class="debug-info">
            <strong>🔍 连接调试信息：</strong>
            <span id="debugInfo">正在检测...</span>
            <button class="btn btn-secondary" onclick="forceRefreshData()" style="margin-left: 10px; padding: 4px 8px; font-size: 0.8em;">
                🔄 强制刷新
            </button>
        </div>

        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="dataStatus"></div>
                <span id="dataStatusText">正在加载数据...</span>
            </div>
            <div id="lastUpdateTime">最后更新：--</div>
        </div>

        <!-- 筛选控制栏 -->
        <div class="filters-section">
            <div class="filters-row">
                <div class="filter-group">
                    <label>📅 年份</label>
                    <select id="yearFilter" onchange="applyFilters()">
                        <option value="all">全部年份</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>📆 月份</label>
                    <select id="monthFilter" onchange="applyFilters()">
                        <option value="all">全部月份</option>
                        <option value="01">1月</option>
                        <option value="02">2月</option>
                        <option value="03">3月</option>
                        <option value="04">4月</option>
                        <option value="05">5月</option>
                        <option value="06">6月</option>
                        <option value="07">7月</option>
                        <option value="08">8月</option>
                        <option value="09">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>📊 类型</label>
                    <select id="typeFilter" onchange="applyFilters()">
                        <option value="all">全部类型</option>
                        <option value="market-trends">市场趋势报告</option>
                        <option value="market-data">市场数据月报</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>🔍 搜索</label>
                    <input type="text" id="searchInput" placeholder="搜索报告..." onkeyup="applyFilters()">
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="resetFilters()">🔄 重置</button>
                    <button class="btn btn-secondary" onclick="refreshData()">⬇️ 刷新数据</button>
                </div>
            </div>
        </div>

        <!-- 显示模式切换 -->
        <div class="view-controls">
            <div class="view-modes">
                <button class="view-mode-btn active" data-mode="grid" onclick="switchViewMode('grid')">
                    🎯 卡片视图
                </button>
            </div>
            <div class="results-info">
                <span id="resultsCount">共 0 个报告</span>
            </div>
        </div>

        <!-- 卡片视图 -->
        <div class="reports-grid" id="reportsGrid">
            <!-- 报告卡片将在这里动态生成 -->
        </div>
    </div>

    <script>
        // 全局变量
        let uploadedFiles = [];
        let filteredFiles = [];
        let dataSource = 'unknown';
        let loadAttempts = 0;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // 初始化页面
        async function initializePage() {
            updateDataStatus('loading', '正在加载数据...');
            updateDebugInfo('开始数据加载...');
            
            await loadData();
            
            if (uploadedFiles.length > 0) {
                updateFilters();
                applyFilters();
            } else {
                showEmptyState();
            }
        }

        // 加载数据（多重尝试）
        async function loadData() {
            const timestamp = Date.now();
            
            // 多个可能的数据源，带缓存破坏参数
            const dataSources = [
                `./data/reports.json?v=${timestamp}`,
                `./data/reports.json?t=${timestamp}`,
                `/data/reports.json?v=${timestamp}`,
                `${window.location.origin}${window.location.pathname}data/reports.json?v=${timestamp}`,
                // 备用：相对路径
                `data/reports.json?v=${timestamp}`
            ];

            let successCount = 0;
            let lastError = null;

            updateDebugInfo(`尝试加载数据源...（共${dataSources.length}个源）`);

            for (let i = 0; i < dataSources.length; i++) {
                const url = dataSources[i];
                try {
                    updateDebugInfo(`尝试源 ${i+1}/${dataSources.length}: ${url.split('?')[0]}`);
                    
                    const response = await fetch(url, {
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const reportCount = data.reports ? data.reports.length : 0;
                        
                        if (reportCount > 0) {
                            uploadedFiles = data.reports;
                            dataSource = 'github';
                            updateDataStatus('success', `已连接到GitHub数据源 (源${i+1})`);
                            updateDebugInfo(`✅ 成功加载 ${reportCount} 个报告`);
                            
                            // 更新最后更新时间
                            if (data.lastUpdated) {
                                const updateTime = new Date(data.lastUpdated).toLocaleString('zh-CN');
                                document.getElementById('lastUpdateTime').textContent = `最后更新：${updateTime}`;
                            }
                            
                            return;
                        } else {
                            updateDebugInfo(`⚠️ 源${i+1}返回0个报告`);
                        }
                    } else {
                        updateDebugInfo(`❌ 源${i+1} HTTP ${response.status}`);
                    }
                } catch (error) {
                    lastError = error;
                    updateDebugInfo(`❌ 源${i+1}失败: ${error.message}`);
                }
            }

            // 所有源都失败，尝试本地存储
            updateDebugInfo('GitHub数据源全部失败，尝试本地存储...');
            try {
                const stored = localStorage.getItem('uploadedFiles');
                if (stored) {
                    uploadedFiles = JSON.parse(stored);
                    dataSource = 'localStorage';
                    updateDataStatus('success', '使用本地数据源');
                    updateDebugInfo(`✅ 从本地加载 ${uploadedFiles.length} 个报告`);
                } else {
                    throw new Error('本地存储为空');
                }
            } catch (error) {
                dataSource = 'none';
                updateDataStatus('error', '数据加载失败');
                updateDebugInfo(`❌ 所有数据源都失败。最后错误: ${lastError?.message || error.message}`);
            }
        }

        // 强制刷新数据
        async function forceRefreshData() {
            updateDebugInfo('🔄 强制刷新中...');
            
            // 清除所有可能的缓存
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                }
                updateDebugInfo('已清除Service Worker缓存');
            }
            
            // 重新加载数据
            await loadData();
            
            if (uploadedFiles.length > 0) {
                updateFilters();
                applyFilters();
            } else {
                showEmptyState();
            }
        }

        // 刷新数据
        async function refreshData() {
            await initializePage();
        }

        // 更新调试信息
        function updateDebugInfo(message) {
            const debugEl = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugEl.innerHTML = `[${timestamp}] ${message}`;
            console.log(`[调试] ${message}`);
        }

        // 更新数据状态显示
        function updateDataStatus(status, message) {
            const statusDot = document.getElementById('dataStatus');
            const statusText = document.getElementById('dataStatusText');
            
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = message;
        }

        // 更新筛选器选项
        function updateFilters() {
            const yearFilter = document.getElementById('yearFilter');
            const years = [...new Set(uploadedFiles.map(f => f.year))].sort((a, b) => b - a);
            
            yearFilter.innerHTML = '<option value="all">全部年份</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}年</option>`;
            });
        }

        // 应用筛选
        function applyFilters() {
            const yearFilter = document.getElementById('yearFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            filteredFiles = uploadedFiles.filter(file => {
                const matchYear = yearFilter === 'all' || file.year === yearFilter;
                const matchMonth = monthFilter === 'all' || file.month === monthFilter;
                const matchType = typeFilter === 'all' || file.type === typeFilter;
                const matchSearch = searchInput === '' || 
                    file.title.toLowerCase().includes(searchInput) ||
                    file.name.toLowerCase().includes(searchInput);

                return matchYear && matchMonth && matchType && matchSearch;
            });

            updateReportsDisplay();
        }

        // 重置筛选器
        function resetFilters() {
            document.getElementById('yearFilter').value = 'all';
            document.getElementById('monthFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            applyFilters();
        }

        // 切换视图模式
        function switchViewMode(mode) {
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            updateReportsDisplay();
        }

        // 更新报告显示
        function updateReportsDisplay() {
            const displayFiles = filteredFiles.length === 0 && uploadedFiles.length > 0 ? uploadedFiles : filteredFiles;
            
            document.getElementById('resultsCount').textContent = `共 ${displayFiles.length} 个报告`;

            if (displayFiles.length === 0) {
                showEmptyState();
                return;
            }

            updateGridView(displayFiles);
        }

        // 显示空状态
        function showEmptyState() {
            const emptyHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #9ca3af;">
                    <div style="font-size: 4em; margin-bottom: 20px;">📄</div>
                    <h3>暂无可用报告</h3>
                    <p>${uploadedFiles.length === 0 ? '尚未发布任何报告文件' : '没有匹配的报告，尝试调整筛选条件'}</p>
                    ${dataSource === 'localStorage' ? '<p style="color: #f59e0b; margin-top: 10px;">💡 提示：当前使用本地模式，配置GitHub后可实现在线同步</p>' : ''}
                    ${dataSource === 'none' ? '<p style="color: #ef4444; margin-top: 10px;">❌ 数据加载失败，请尝试刷新页面或联系管理员</p>' : ''}
                </div>
            `;
            
            document.getElementById('reportsGrid').innerHTML = emptyHTML;
        }

        // 更新网格视图
        function updateGridView(files) {
            const sortedFiles = [...files].sort((a, b) => {
                const dateA = new Date(a.year, parseInt(a.month) - 1);
                const dateB = new Date(b.year, parseInt(b.month) - 1);
                return dateB - dateA;
            });

            const reportsGrid = document.getElementById('reportsGrid');
            reportsGrid.innerHTML = sortedFiles.map(file => {
                const reportUrl = file.url || `./reports/${file.name}`;
                
                return `
                    <div class="report-card">
                        <div class="report-header">
                            <div class="report-title">${file.title}</div>
                            <div class="report-meta">
                                ${file.type === 'market-trends' ? '📈 市场趋势' : '📊 数据分析'} · 
                                更新时间：${file.uploadTime.split(' ')[0]}
                            </div>
                        </div>
                        <div class="report-content">
                            <div class="report-preview">
                                📄 HTML报告预览
                            </div>
                            <div class="report-actions">
                                <button class="btn" onclick="openReport('${reportUrl}', '${file.title}')">
                                    🔗 打开报告
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 打开报告
        function openReport(url, title) {
            window.open(url, '_blank', 'width=1200,height=800');
        }

        // 管理员功能（简化版）
        function toggleAdminMode() {
            alert('管理员功能已在此简化版本中禁用，请使用完整版本进行管理操作。');
        }
    </script>
</body>
</html>